import { ObjectType } from '../../ObjectType';
import { createGraphQLSchema } from '../../createGraphQLSchema';
import { createType } from '../GraphType';
import { createResolver } from '../../Resolver';

describe('schema.getGraphQLTypescript', () => {
  afterEach(ObjectType.reset);

  it('works', async () => {
    const UserType = createType('User', {
      description: 'user entity',
      object: {
        id: 'ID',
      },
    });

    const LoginType = createType('LoginRegister', {
      object: {
        time: 'int',
        device: 'string',
      },
    });

    UserType.addRelation({
      name: 'logins',
      description: 'user logins',
      args: {
        since: 'date?',
      },
      type: { type: LoginType, list: true },
      async resolve(): Promise<any> {},
    });

    createResolver({
      type: [UserType] as const,
      name: 'findUsers',
      description: 'find users resolver',
      args: { limit: 'int' },
      async resolve(): Promise<any> {
        return {};
      },
    });

    const schema = createGraphQLSchema();

    const sut = await schema.utils.generateClientUtils();

    expect(sut.split('\n')).toEqual([
      '// Autogenerated, do not edit by hand',
      '',
      '/* istanbul ignore file */',
      '',
      '/* eslint-disable */',
      '',
      "import { GraphType } from '@darch/schema';",
      '',
      'export type GraphQLClientError = { message: string; path: string[] };',
      '',
      'export type ID = number | string;',
      '',
      'export type GraphQLClientResponse<Result> =',
      '  | { data: Result; errors: null }',
      '  | { data: null; errors: GraphQLClientError[] };',
      '',
      'export type findUsersPayload = {',
      '  id: ID;',
      '  logins: {',
      '    time: number;',
      '    device: string;',
      '  }[];',
      '}[];',
      '',
      'export type findUsersInput = {',
      '  limit: number;',
      '};',
      '',
      'export interface ExpectedGraphQLClient {',
      '  /**',
      'find users resolver',
      '**/',
      '  findUsers: {',
      '    args: findUsersInput;',
      '    payload: GraphQLClientResponse<findUsersPayload>;',
      '  };',
      '}',
      '',
      'export const graphqlClientHelpers = {',
      '  findUsers: {',
      "    name: 'findUsers',",
      "    kind: 'query',",
      "    payload: GraphType.getOrSet('findUsersPayload', {",
      "      type: 'object',",
      '      def: {',
      "        id: { type: 'ID', optional: false, list: false },",
      '        __dschm__: {',
      '          list: false,',
      '          optional: false,',
      "          type: 'meta',",
      "          def: { id: 'User' },",
      '        },',
      '      },',
      '      list: true,',
      '      optional: false,',
      "      description: 'user entity',",
      '    } as const),',
      '',
      "    input: GraphType.getOrSet('findUsersInput', {",
      "      type: 'object',",
      '      def: {',
      "        limit: { type: 'int', optional: false, list: false },",
      '        __dschm__: {',
      '          list: false,',
      '          optional: false,',
      "          type: 'meta',",
      '          def: { id: null },',
      '        },',
      '      },',
      '      optional: false,',
      '      list: false,',
      '    } as const),',
      '',
      '    operation: {',
      '      varNames: {',
      '        limit: {',
      "          comments: '',",
      "          name: 'limit',",
      "          varName: 'findUsers_limit',",
      "          type: 'Int!',",
      '        },',
      '      },',
      '      query:',
      "        'fragment LoginRegister3438313585Fragment($findUsers_logins_since: Date) on LoginRegister {\\n  time\\n  device\\n}\\nquery findUsers($findUsers_limit: Int!, $findUsers_logins_since: Date) {\\n  findUsers(limit: $findUsers_limit, since: $findUsers_logins_since) {\\n    id\\n    logins(since: $findUsers_logins_since) {\\n      ...LoginRegister3438313585Fragment\\n    }\\n  }\\n}\\n',",
      '    } as const,',
      '  },',
      '} as const;',
      '',
      'export type GraphqlClientHelpers = typeof graphqlClientHelpers;',
      'export type GraphQLEntry = GraphqlClientHelpers[keyof GraphqlClientHelpers];',
      '',
      "export type GraphQLFetchParams<K extends GraphQLEntry['name']> = {",
      '  operationInfo: GraphqlClientHelpers[K];',
      '  operationName: K;',
      "  getBody: (args: ExpectedGraphQLClient[K]['args']) => {",
      '    query: string;',
      '    variables: Record<string, any>;',
      '    operationName: K;',
      '  };',
      "  parseArgs: (args: ExpectedGraphQLClient[K]['args']) => Record<string, any>;",
      "  mountBodyString(args: ExpectedGraphQLClient[K]['args']): string;",
      '};',
      '',
      "export function getGraphQLFetchHelpers<MethodName extends GraphQLEntry['name']>(",
      '  methodName: MethodName',
      '): GraphQLFetchParams<MethodName> {',
      '  const helpers = graphqlClientHelpers[methodName];',
      '',
      '  function parseArgs(args: any) {',
      '    const vars: Record<string, any> = {};',
      '    const parsedArgs: any = helpers.input.parse(args || {}, (_, error) => {',
      '      return `\\nGraphQLClientArgumentsError: method ${methodName}: \\n${error.message}`;',
      '    });',
      '',
      '    Object.entries(helpers.operation.varNames).forEach(',
      '      ([inputVarName, { varName }]) => {',
      '        vars[varName] = parsedArgs[inputVarName];',
      '      }',
      '    );',
      '',
      '    return vars;',
      '  }',
      '',
      '  function getBody(args: any) {',
      '    const variables = parseArgs(args);',
      '    return {',
      '      query: helpers.operation.query,',
      '      variables,',
      '      operationName: methodName,',
      '    };',
      '  }',
      '',
      '  function mountBodyString(args: any) {',
      '    const body = getBody(args);',
      '    return JSON.stringify(body);',
      '  }',
      '',
      '  return {',
      '    operationInfo: helpers,',
      '    operationName: methodName,',
      '    parseArgs,',
      '    getBody,',
      '    mountBodyString,',
      '  };',
      '}',
      '',
    ]);
  });
});
